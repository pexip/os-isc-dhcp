#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix denial of service via memory leaks
# Origin: backported from 4.1-ESV-R6

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' isc-dhcp-4.1.ESV-R4~/common/options.c isc-dhcp-4.1.ESV-R4/common/options.c
--- isc-dhcp-4.1.ESV-R4~/common/options.c	2012-07-25 17:03:40.000000000 -0400
+++ isc-dhcp-4.1.ESV-R4/common/options.c	2012-07-25 17:03:55.266102448 -0400
@@ -2357,6 +2357,8 @@
 
 	/* And let go of our references. */
       cleanup:
+	if (lbp != NULL)
+		buffer_dereference(&lbp, MDL);
 	option_dereference(&option, MDL);
 
 	return 1;
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' isc-dhcp-4.1.ESV-R4~/server/dhcpv6.c isc-dhcp-4.1.ESV-R4/server/dhcpv6.c
--- isc-dhcp-4.1.ESV-R4~/server/dhcpv6.c	2011-05-10 21:00:51.000000000 -0400
+++ isc-dhcp-4.1.ESV-R4/server/dhcpv6.c	2012-07-25 17:04:09.330102808 -0400
@@ -1240,6 +1240,8 @@
 	struct data_string packet_oro;
 	isc_boolean_t no_resources_avail;
 
+	memset(&packet_oro, 0, sizeof(packet_oro));
+
 	/* Locate the client.  */
 	if (shared_network_from_packet6(&reply.shared,
 					packet) != ISC_R_SUCCESS)
@@ -1262,7 +1264,6 @@
 	 * Get the ORO from the packet, if any.
 	 */
 	oc = lookup_option(&dhcpv6_universe, packet->options, D6O_ORO);
-	memset(&packet_oro, 0, sizeof(packet_oro));
 	if (oc != NULL) {
 		if (!evaluate_option_cache(&packet_oro, packet, 
 					   NULL, NULL, 
@@ -1517,6 +1518,8 @@
 		packet_dereference(&reply.packet, MDL);
 	if (reply.client_id.data != NULL)
 		data_string_forget(&reply.client_id, MDL);
+	if (packet_oro.buffer != NULL)
+		data_string_forget(&packet_oro, MDL);
 	reply.renew = reply.rebind = reply.prefer = reply.valid = 0;
 	reply.cursor = 0;
 }
